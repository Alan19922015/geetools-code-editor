/**
 * CheckSelect Widget
 * Author: Rodrigo E. Principe
 * email: fitoprincipe82@gmail.com
 * license: MIT
 **/

var labels = require('users/fitoprincipe/geetools:labels')
var tools = require('users/fitoprincipe/geetools:tools')
var helpers = require('users/fitoprincipe/geetools:helpers_js')

var labelWidget = function(fc, prop, options) {
  
  var def = {
    fontType: 'Arial',
    fontSize: 32,
    scale: 30,
    red: 1,
    green: 0,
    blue: 0,
    map: Map
  }
  
  this.options = helpers.get_options(def, options)
  this.map = this.options.map
  
  this.fc = fc
  this.prop = prop
  
  var fonts = ['Arial', 'Consolas']
  var sizes = {
    'Arial': ['10','12','14','16','18','24','32','64'],
    'Consolas': ['16', '18', '24', '32']
  }
  
  // Check if passed args are in in the lists of availables
  if (this.options.fontType in fonts) {
    this.fontType = this.options.fontType
  } else {
    this.fontType = def.fontType
  }
  
  if (this.options.fontSize in sizes[this.fontType]) {
    this.fontSize = this.options.fontSize
  } else {
    this.fontSize = def.fontSize
  }
  
  // DROPDOWNS
  this.sizesDD = ui.Select([])
  this.fontsDD = ui.Select({
    items: fonts
  })
  
  // SET DD OPTIONS
  var app = this
  print(app)
  this.fontsDD.onChange(function(font){
    //print(app)
    this.sizesDD.items().reset(sizes[font])
    this.sizesDD.setValue(this.fontSize.toString())
  })
  this.fontsDD.setValue(this.fontType, true)
  
  var fontPanel = ui.Panel([this.fontsDD, this.sizesDD], ui.Panel.Layout.flow('horizontal'))
  
  var scale = ui.Textbox({
    value: this.options.scale.toString(), 
    style:{width:'50px'}
  })
  var scalePanel = ui.Panel([ui.Label('scale:'), scale], ui.Panel.Layout.flow('horizontal'))
  
  var red = ui.Textbox({value: this.options.red.toString(), style:{width:'40px'}})
  var green = ui.Textbox({value: this.options.green.toString(), style:{width:'40px'}})
  var blue = ui.Textbox({value: this.options.blue.toString(), style:{width:'40px'}})
  var colors = ui.Panel([
    ui.Label('R'), red, 
    ui.Label('G'), green, 
    ui.Label('B'), blue], ui.Panel.Layout.flow('horizontal'))
  
  this.panel = ui.Panel([fontPanel, scalePanel, colors])
}

labelWidget.prototype.getLabels = function() {
  var bounds = tools.map.getBounds(this.map)
  
  var filtered = this.fc.filterBounds(bounds)
  var f = fontsDD.getValue()
  var s = sizesDD.getValue()
  var sc = scale.getValue()
  var color = labels.rgbToHex(Number(red.getValue()), Number(green.getValue()), Number(blue.getValue()))
  var l = labels.labelCollection(filtered, prop, Number(sc), {
      textColor: color,
      fontType: f,
      fontSize: s
    })
  var name = 'labels '+prop+' '+f+' '+s+' '+sc+' '+color
  var layer = tools.map.getLayer(name)
  var newlayer = ui.Map.Layer(l, {}, name)
  if (layer) {
    tools.map.replaceLayer(layer, newlayer)
  } else {
    Map.addLayer(l, {}, name)
  }
}

labelWidget.prototype.build = function() {
  return this.panel
}

labelWidget.prototype.addTo = function(widget) {
  widget.add(this.build())
  this.parent = widget
  return widget
}

labelWidget.prototype.insertTo = function(widget, position) {
  widget.insert(position, this.build())
  this.parent = widget
  return widget
}

exports.labelWidget = labelWidget

var Test = function() {
  var table = ee.FeatureCollection('users/fitoprincipe/SAT/formosa_08_11')
  var wid = new labelWidget(table, 'Id')
  wid.addTo(Map)
}

Test()