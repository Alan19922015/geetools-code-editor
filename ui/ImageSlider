var sat = require('users/fitoprincipe/geetools:satellite')
var tools = require('users/fitoprincipe/geetools:tools')
var wid = require('users/fitoprincipe/geetools:widgets')
var helpers = require('users/fitoprincipe/geetools:helpers_js')

var ImageSlider = function(collection, options) {
  var def = {
    start: null,
    end: null,
    title: 'ImageSlider',
    width: 200,
    mosaic: true,
    site: null,
    map: Map
  }
  
  this.options = helpers.get_options(def, options)
  var ordered = collection.sort('system:time_start', true)
  this.collection = ordered
  
  if (!this.options.start) {
    var first = ordered.first()
    this.options.start = first.date().format().getInfo()
  }
  if (!this.options.end) {
    var last = ee.Image(ordered.toList(ordered.size()).get(-1))
    this.options.end = last.date().format().getInfo()
  }
  
  this.slider = ui.DateSlider(this.options.start, this.options.end)
  var forth = ui.Button({
    label: 'forward'
  })
  var back = ui.Button({
    label: 'backward'
  })
  var buttons = ui.Panel([back, forth])
  buttons.setLayout(ui.Panel.Layout.flow('horizontal'))
  
  this.panel = ui.Panel({
    widgets: [ui.Label(this.options.title), this.slider, buttons]
  })
  
  this.setWidth(this.options.width)
  this.images = {}
}

ImageSlider.prototype.build = function() {
  return this.panel
}

ImageSlider.prototype.addTo = function(widget) {
  widget.add(this.build())
  this.parent = widget
  return widget
}

ImageSlider.prototype.insertTo = function(widget, position) {
  widget.insert(position, this.build())
  this.parent = widget
  return widget
}

ImageSlider.prototype.setWidth = function(width) {
  var ps = new helpers.PixelSize(width)
  this.panel.style().set('width', ps.value())
  var sliderwidth = ps.subtract(30).value()
  this.slider.style().set('width', sliderwidth)
}

ImageSlider.prototype.getDate = function() {
  return this.slider.getValue()[0]
}

ImageSlider.prototype.getImage = function(date, site, mosaic) {
  var self = this
  site = site || this.options.site
  mosaic = mosaic || this.options.mosaic
  var date = date || this.getDate()
  
  if (this.images[date] === undefined) {
    this.images[date] = {}
  }
  
  var filterCol = function(s) {
    var start = ee.Date(date)
    var end = start.advance(1, 'day')
    var filtered = self.collection.filterDate(start, end).filterBounds(s)
    return filtered
  }
  
  var getImage = function(filtered, geom) {
    var size = filtered.size()
    if (mosaic) {
      var image = filtered.mosaic().set('system:time_start', date).clip(geom)
    } else {
      var image = filtered.first()
    }
    return image
  }
  
  if (site) {
    var hash = helpers.hash(site.serialize())
    if (this.images[date][hash] === undefined) {
      var filtered = filterCol(site)
      var size = filtered.size().getInfo()
      if (size <= 0) {
        this.images[date][hash] = null
        return null
      } else {
        var geom = tools.imageCollection.mergeGeometries(filtered)
        var image = getImage(filtered, geom)
        this.images[date][hash] = image
        return image
      }
    } else {
      return this.images[date][hash]
    }
  } else {
    site = tools.map.getBounds(this.options.map)
    var filtered = filterCol(site)
    var size = filtered.size().getInfo()
    if (size <= 0) {
        this.images[date][hash] = null
        return null
    } else {
      var geom = tools.imageCollection.mergeGeometries(filtered)
      var hash = helpers.hash(geom.serialize())
      if (this.images[date][hash] === undefined) {
        var image = getImage(filtered, geom)
        this.images[date][hash] = image
        return image
      } else {
        return this.images[date][hash]
      }
    }
  }
}

ImageSlider.prototype.forward = function(site, mosaic) {
  site = site || this.options.site || this.options.map.getBounds()
  mosaic = mosaic || this.options.mosaic
  /*
  var start = ee.Date(this.getValue())
  var end = ee.Date(this.slider.getEnd()).advance(1, 'day')
  var filtered = this.collection.filterDate(start, end)
  var image = filtered.first()
  // set slider value
  image.date().evaluate(function(d){this.slider.setValue(d)})
  this.image
  */
}

ImageSlider.prototype.backward = function() {
  var start = ee.Date(this.slider.getStart())
  var end = ee.Date(this.getValue()).advance(1, 'day')
  var filtered = this.collection.filterDate(start, end)
  var image = ee.Image(filtered.toList(filtered.size()).get(-1))
  // set slider value
  image.date().evaluate(function(d){this.slider.setValue(d)})
  this.image
}

var test = function() {
  var col = ee.ImageCollection('COPERNICUS/S2')
  var slider = new ImageSlider(col, {start: '2018-01-01', end:'2018-05-01'})
  slider.setWidth(500)
  slider.addTo(Map)
  var but = ui.Button('get')
  but.onClick(function() {
    var i = slider.getImage()
    if (i) {
      Map.addLayer(i, {bands:['B4', 'B3', 'B2'], min:0, max:5000}, 'S2')
    } else { print('no images') }
  })
  Map.add(but)
}

test()
