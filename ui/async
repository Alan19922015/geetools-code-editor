/**
 * Async Widgets
 * Author: Rodrigo E. Principe
 * email: fitoprincipe82@gmail.com
 * license: MIT
 **/

var helpers = require('users/fitoprincipe/geetools:helpers_js')
 
var asyncSelect = function(options) {
  
  this.loading = 'Loading...'
  
  this.options = options
  
  this.sel = ui.Select({
    items: [],
    placeholder: this.loading,
    value: null,
    onChange: this.onChange,
    disabled: this.disabled,
    style: options.style
  })
  
  this.setItems(options.items, options.value)
  
  // inherit
  // getters
  this.items = function() {return this.sel.items()}
  this.getPlaceholder = function() {return this.sel.getPlaceholder()}
  this.getDisabled = function() {return this.sel.getDisabled()}
  this.getValue = function() {return this.sel.getValue()}
  this.style = function() {return this.sel.style()}
  // setters
  this.setDisabled = function(disabled) {this.sel.setDisabled(disabled)}
  this.setPlaceholder = function(placeholder) {this.sel.setPlaceholder(placeholder)}
  this.onChange = function(callback) {this.sel.onChange(callback)}
  this.unlisten = function(idOrType) {this.sel.unlisten(idOrType)}
}

asyncSelect.prototype.setValue = function(value, trigger) {
  try {
    this.sel.setValue(value, trigger)
  } catch (e) {
    print('value '+value+' may have not been retrieved yet, you can parse a value in function setItems')
  }
}

asyncSelect.prototype.formatItems = function(items) {
  if (helpers.object.is(items, 'Array')) {
    return this.options.items
  } else {
    return items.map(function(it){return ee.Algorithms.String(it)})
  }
}

asyncSelect.prototype.setItems = function(items, value) {
  items = this.formatItems(items)
  this.sel.setPlaceholder(this.loading)
  try {
    items.evaluate(this.evaluation(value))
  } catch (e) {
    this.sel.items().reset(items)
    this.sel.setPlaceholder('Select a value')
  }
}

asyncSelect.prototype.evaluation = function(value) {
  var self = this
  var wrap = function(items, error) {
    if (error === undefined) {
      self.sel.items().reset(items)
      self.sel.setPlaceholder('Select a value')
      if (value) {
        self.sel.setValue(value)
      }
    } else {
      self.sel.setPlaceholder('Error')
      print(error)
    }
  }
  return wrap
}

asyncSelect.prototype.build = function() {
  return this.sel
}

exports.asyncSelect = asyncSelect

var test = function() {
  var image = ee.Image('COPERNICUS/S2_SR/20170328T083601_20170328T084228_T35RNK')
  
  var list = image.reduceRegion({
    reducer: 'mean',
    geometry: image.geometry().centroid().buffer(10000),
    scale: 100
  }).values().map(function(item){return ee.Number(item).toInt()})
  
  // UPPER LIMIT
  var select = new asyncSelect({
    items: list,
    //items: ['a', 'b']
    //value: "5412"
  })
  Map.add(select.build())
  
  //select.setItems(list)
  Map.onClick(function(coords){select.setValue("5412")})
}

//test()