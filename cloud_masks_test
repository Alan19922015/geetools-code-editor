/***
 * Tests for cloud mask functions
 * 
 * Author: Rodrigo E. Principe
 * email: fitoprincipe82@gmail.com
 * License: MIT
 */
 
 var s2mask = require('users/fitoprincipe/geetools:cloud_masks').sentinel2
 var landsatSR = require('users/fitoprincipe/geetools:cloud_masks').landsatSR
 var cloud = require('users/fitoprincipe/geetools:cloud_masks')
 
 
 var show = function(colid, cloud_prop, viz, name, func, params, cloud_percent) {
   var percent = cloud_percent || 40;
   var cent = Map.getCenter();
   var col = ee.ImageCollection(colid)
             .filterBounds(cent)
             .filterMetadata(cloud_prop, 'greater_than', percent)
             //.filterDate('2017-01-01', '2017-03-01')
             .sort(cloud_prop);
   
   if (col.size().getInfo() !== 0) {
     var img = ee.Image(col.first());
     //var vis = {bands:['B8', 'B12', 'B4'], min:0, max:5000}
     var masked = func(params)(img)
     Map.addLayer(masked, viz, name+' masked');
     Map.addLayer(img, viz, name+' NOT masked', false);
     Map.centerObject(img)
   }
   else {
     print('Collection is empty')
   }
 }
 
 
 var sentinel2 = function(options) {
   var opt = options || null
   show('COPERNICUS/S2', 'CLOUDY_PIXEL_PERCENTAGE', 
        {bands:['B8', 'B12', 'B4'], min:0, max:5000}, 
        'SENTINEL 2', cloud.make.sentinel2, opt)
 }
 
 
 var landsat8SR = function(options) {
   var opt = options || null
   show('LANDSAT/LC08/C01/T1_SR', 'CLOUD_COVER', 
        {bands:['B5', 'B7', 'B4'], min:0, max:5000}, 
        'Landsat 8 SR', cloud.make.landsatSR, opt)
 }
 
 var landsat8SR_ = function(options, name) {
   var n = name || 'Landsat 8 SR'
   var cent = Map.getCenter();
   var col = ee.ImageCollection('LANDSAT/LC08/C01/T1_SR')
             .filterBounds(cent)
             .filterMetadata('CLOUD_COVER', 'greater_than', 40)
             .sort('CLOUD_COVER');
   
   if (col.size().getInfo() !== 0) {
     var img = ee.Image(col.first());
     var vis = {bands:['B5', 'B7', 'B4'], min:0, max:5000}
     var masked = landsatSR(options)(img);
     Map.addLayer(masked, vis, n+' masked');
     Map.addLayer(img, vis, n+' NOT masked', false);
     Map.centerObject(img)
   }
   else {
     print('Collection is empty')
   }
 };
 
 var landsat5SR = function(options, name) {
   var n = name || 'Landsat 5 SR'
   var cent = Map.getCenter();
   var col = ee.ImageCollection('LANDSAT/LT05/C01/T1_SR')
             .filterBounds(cent)
             .filterMetadata('CLOUD_COVER', 'greater_than', 40)
             .sort('CLOUD_COVER');
   if (col.size().getInfo() !== 0) {
     var img = ee.Image(col.first());
     var vis = {bands:['B4', 'B5', 'B3'], min:0, max:5000}
     var masked = landsatSR(options)(img);
     Map.addLayer(masked, vis, n+' masked');
     Map.addLayer(img, vis, n+' NOT masked', false);
     Map.centerObject(img)
   }
   else {
     print('Collection is empty')
   }
 };
 
 var landsat7SR = function(options, name) {
   var n = name || 'Landsat 7 SR'
   var cent = Map.getCenter();
   var col = ee.ImageCollection('LANDSAT/LE07/C01/T1_SR')
             .filterBounds(cent)
             .filterMetadata('CLOUD_COVER', 'greater_than', 40)
             .sort('CLOUD_COVER');
   
   if (col.size().getInfo() !== 0) {
     var img = ee.Image(col.first());
     var vis = {bands:['B4', 'B5', 'B3'], min:0, max:5000}
     var masked = landsatSR(options)(img);
     Map.addLayer(masked, vis, n+' masked');
     Map.addLayer(img, vis, n+' NOT masked', false);
     Map.centerObject(img)
   }
   else {
     print('Collection is empty')
   }
 };
 
 var landsat4SR = function(options, name) {
   var n = name || 'Landsat 4 SR'
   var cent = Map.getCenter();
   var col = ee.ImageCollection('LANDSAT/LT04/C01/T1_SR')
             .filterBounds(cent)
             .filterMetadata('CLOUD_COVER', 'greater_than', 40)
             .sort('CLOUD_COVER');
   
   if (col.size().getInfo() !== 0) {
   
     var img = ee.Image(col.first());
     var vis = {bands:['B4', 'B5', 'B3'], min:0, max:5000}
     var masked = landsatSR(options)(img);
     Map.addLayer(masked, vis, n+' masked');
     Map.addLayer(img, vis, n+' NOT masked', false);
     Map.centerObject(img)
     }
   else {
     print('Collection is empty')
   }
 };
 
 
 var landsat4TOA = function(options, name) {
   var n = name || 'Landsat 4 TOA'
   var opt = options || null
   show('LANDSAT/LT04/C01/T1_TOA', 
        'CLOUD_COVER',
        {bands:['B4', 'B5', 'B3'], min:0, max:0.5},
        n,
        cloud.make.landsatTOA,
        opt)
 }
 
 exports.sentinel2 = sentinel2
 exports.landsat8SR = landsat8SR
 exports.landsat5SR = landsat5SR
 exports.landsat4SR = landsat4SR
 exports.landsat7SR = landsat7SR
 exports.landsat4TOA = landsat4TOA