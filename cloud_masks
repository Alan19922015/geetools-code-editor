/***
 * Functions to apply cloud mask to different collections
 * 
 * Author: Rodrigo E. Principe
 * email: fitoprincipe82@gmail.com
 * License: MIT
 */

var help = {};

var computeQAbits = function(image, start, end, newName) {
    var pattern = 0;

    for (var i=start; i<=end; i++) {
        pattern += Math.pow(2, i);
    }
    
    return image.select([0], [newName]).bitwiseAnd(pattern).rightShift(start);
};

var sentinel2 = function(image) {
  
  var cloud_mask = image.select("QA60");
  var opaque = computeQAbits(cloud_mask, 10, 10, "opaque")
  var cirrus = computeQAbits(cloud_mask, 11, 11, "cirrus")
  var mask = opaque.Or(cirrus)
  
  return image.updateMask(mask.Not());
}

help['sentinel2'] = 'function to mask out cloud from Sentinel 2 images. Use on map function directly';

exports.help = help
exports.sentinel2 = sentinel2